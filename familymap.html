
<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8/>
  <title> Family Map </title>
  <!-- Styles -->
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <link rel="stylesheet" href = "assets/styles.css" />
  <link rel = "stylesheet" href = "assets/foundation.css" />
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <!-- External Scripts -->
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
  <script src = "https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation.js" type = "text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation/foundation.slider.js" type = "text/javascript"></script>
  <script src= "https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation/foundation.reveal.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
  <script src="assets/Leaflet.MakiMarkers.js"></script>
  
</head> 

<body>

  <!-- Modals - HTML  -->
<a href="#" data-reveal-id="myModal" class = "helptext"> Help </a>
<a href="#" data-reveal-id="endingModal"></a>
<a href="#" data-reveal-id="startingModal"></a>



<div id="endingModal" class="reveal-modal tiny" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog" style = "background: transparent !important">
  <div class = "endingmodalbox">
    <div class = "center endingmodalbutton" id = "resetbtn"> <a class = "close" aria-label="Close">Play map again</a></div>  
    <div class = "center endingmodalbutton"> <a href = "groups.html"> Return to groups </a></div>
  </div>
</div>


<div id="myModal" class="reveal-modal small" data-reveal aria-labelledby="secondmodalTitle" aria-hidden="true" role="dialog">
  <h2 id="secondmodalTitle"> Help Guide </h2>
  <p class="lead"> This map displays a month's worth of real data. </p>
  <p> Click the buttons on the left to <strong>play, pause, or reset</strong> the map. To <strong>fast forward or rewind</strong>, click the slider rectangle and use your arrow keys to move left or right. You can <strong>move the map around </strong>by holding down your mouse and dragging. Click the "home" and "hospital" icons to <strong>remove labels</strong>. </p>
  <p> Click <a href = "groups.html">here</a> to return to the groups page, or use the navigation bar at the bottom right. </p>
  <a class="close-reveal-modal" aria-label="Close">&#215;</a>
</div>


<div id="startingModal" class="reveal-modal tiny" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog" style = "background: transparent !important">
  <div class = "endingmodalbox">
    <div class = "center endingmodalbutton" id = "resetbtn"> <a class = "close" aria-label="Close">Play</a></div>  
  </div>
</div>

<!-- Navigation Bar -->
<div class = "navbar">
    <ul class = "navbar-list">
      <li class = "navbar-item">
        <a class = "navbar-link" href = "about.html"> About </a>
      </li>
      <li class = "navbar-item">
        <a class = "navbar-link" href="groups.html"> The Groups </a>
      </li>
      <li class = "navbar-item">
        <a class = "navbar-link" href = "maps.html"> The Maps  </a>
      </li>
    </ul>
  </div>


<!-- Interface -->
    <div id = "container">
    <div id="map"></div>
  </div>
<div id = "aboutbar">
  <div class = "abouttext">
    <strong>Story: Family </strong></br>
  </div>
   <div id = "message"> </div>
   <div class="row">
  </div>
</div>

  <div class = "controls">
        <div class = "btn active" id = "playbtn">Play</div> 
        <div class = "btn" id = "pausebtn">Pause</div>
        <div class = "btn" id = "resetbtn">Reset</div>
  </div>

 <div id = "seek">
  <div class = "seekbarvalue black"></div>
  <input type ="range" id="seekbar" value="0" /> 
</div>

<div id = "timebar">
    <div id = "timevalue"> </div>
</div>

      <div class = "extrainformation">
        <p class = "stats">
          <div id = "flatmate1key"><div class ="keytext">Mother</div></div>
          <div id = "flatmate2key"><div class ="keytext">Father</div></div>
          <div id = "flatmate4key"><div class ="keytext">Grandmother</div></div>
        </p>
    </div>


<!-- "Learn More" Link and Content  -->
<!-- <a data-dropdown="drop2" aria-controls="drop2" aria-expanded="false" class = "learnmore">Insights</a>


<div id="drop2" data-dropdown-content class="f-dropdown content learnmorecontent" aria-hidden="true" tabindex="-1">
      <h3> The Difficulty of Accurate Tracking </h3>
      <p> This was the only group whose data were tracked by the mobile app <a href="movesapp.com">Moves </a> instead of OpenPaths. Moves has a much more sophisticated technique for gathering and tracking location data. You can tell this by comparing the paths on this map with any of the other maps (compared to this one, the other maps have mainly straight lines, indicating longer gaps in between when their phones were recording GPS logs).</p>
      <p> The downside of Moves is that it's owned by Facebook. If you're already on Facebook, using it means giving up even more your data to a large company.</p>
      <p> The Family whose data is depicted here had all already installed Moves on their phones before the project began. For the rest of us, their story typifies the difficult truth of trying to track your own data: most of the companies who make it easy for you to see your data are also quietly benefitting and making profits off of that same data. The result? You make data and give it away for free everyday. </p>
      
</div> -->



<a href="#" data-dropdown="hover1" data-options="is_hover:true; hover_timeout:9000" class = "learnmore">Insights </a>
<a href="#" data-dropdown="hover2" data-options="is_hover:true; hover_timeout:9000" class = "learnevenmore">Conclusions </a>
<a href="#" data-dropdown="hover3" data-options="is_hover:true; hover_timeout:9000" class = "learnthemost">Extra Data </a>



<div id="hover1" class="f-dropdown learnmorecontent tiny" data-dropdown-content>
<h3> The Difficulty of Accurate Tracking </h3>
      <p> Your phone's always tracking your data, but you don't always have access to it. Some applications, like OpenPaths and Moves,
      allow you to see that information. They run in the background of your phone, making constant GPS logs of where you are. The more frequent those calls, the better the data will be, as there will be fewer gaps in between the previous moments and the other ones.  </p>
  </div>

<div id="hover2" class="f-dropdown learnmorecontent" data-dropdown-content>  
      <h3> Things To Consider When Tracking Your Data </h3> 
      <p> This was the only group whose data were tracked by the mobile app <a href="movesapp.com">Moves </a> instead of OpenPaths. Moves has a much more sophisticated technique for gathering and tracking location data. You can tell this by comparing the paths on this map with any of the other maps (compared to this one, the other maps have mainly straight lines, indicating longer gaps in between when their phones were recording GPS logs)</p>
       <p> The downside of Moves is that it's owned by Facebook. If you're already on Facebook, using it means giving up even more your data to a large company.</p>
      <p> The Family whose data is depicted here had all already installed Moves on their phones before the project began. For the rest of us, their story typifies the difficult truth of trying to track your own data: most of the companies who make it easy for you to see your data are also quietly benefitting and making profits off of that same data. The result? You make data and give it away for free everyday. </p>
</div>

<div id="hover3" class="f-dropdown learnmorecontent tiny" data-dropdown-content>
<h3>Extra Data</h3>
      <p>For this group, I also collected the Father's Facebook data. On there, I could easily figure out when the son was done. </p>
  </div>

<!--  // Map  -->
  <script type="text/javascript">
  var initialTimestamp = 1425210673;
  var color1 = "#0096FF"; //mother
  var color2 = "#FF5000"; //father
  var color3 = "#590B90"; //motherinlaw
  var maincolor = "#2c2c9a";
  var specialeventscolor = "#cead23";
  var mainMap = setupMapObject(51.527928, -0.183626, 14, 'whitemap/{z}/{x}/{y}.png', 16, 51.5280495, -0.189, 51.517319, -0.173,[color1, color2, color3] );

  var lineGenerator = d3.svg.line()
      .interpolate("linear")
      .x(function(d) {return applyLatLngToLayer(d).x})
      .y(function(d) {return applyLatLngToLayer(d).y});

  function setupMapObject(latitude, longitude, zoom, tileURL, maximumZoom, markerlat, markerlong, marker2lat, marker2long,  colors){
            /***  multiple popup hack  http://jsfiddle.net/paulovieira/yVLJf/ ***/
      L.Map = L.Map.extend({
          openPopup: function(popup) {
              //this.closePopup();  
              this._popup = popup;
              return this.addLayer(popup).fire('popupopen', {
                  popup: this._popup
              });
          }
      });

      var map = L.map('map', {
          attributionControl: false, zoomControl: false, minZoom: 10, maxZoom: 14 })
          .setView([latitude, longitude], zoom); 
      var tiles = L.tileLayer(tileURL, {
          maxZoom: maximumZoom});
          tiles.addTo(map);
      var svg = d3.select(map.getPanes().overlayPane).append("svg");
      var g1 = svg.append("g").attr();
      var g2 = svg.append("g").attr();
      var icon = L.MakiMarkers.icon({icon: "building", color: "#888", size: "s"});
      var icon2 = L.MakiMarkers.icon({icon: "building", color: "#000", size: "s"});
      var marker = L.marker([markerlat, markerlong], {icon:icon}).addTo(map);
      marker.bindPopup("<b>Home</br>").openPopup();
      var marker2 = L.marker([marker2lat, marker2long], {icon:icon2}).addTo(map);
      marker2.bindPopup("<b>Hospital</br>").openPopup();
      var colors = colors;    
      return {
        map: map,
        tiles: tiles,
        svg: svg,
        g1: g1,
        g2: g2,
        marker: marker,
        marker2: marker2,
        colors: colors
      };
  }

  function setSVGHeightAndWidth(geojsons, linepaths){ 
      var transform = d3.geo.transform({
        point: projectPoint
      });
      var d3path = d3.geo.path().projection(transform);
     
      //projecting points because we have to convert geometries 
      function projectPoint(x, y) {
          var point = mainMap.map.latLngToLayerPoint(new L.LatLng(y, x));
          this.stream.point(point.x, point.y);
      }     
      var top, left, bottom, right;
      var isFirstIteration = true;
      $.each(geojsons, function (index){
          var newBounds = d3path.bounds(geojsons[index]); 
          if (isFirstIteration) {
            top = newBounds[0][1];
            left = newBounds[0][0];
            bottom = newBounds[1][1];
            right = newBounds[1][0];
            isFirstIteration = false;
          } else {
            if (newBounds[0][1] < top){
              top = newBounds[0][1];
            }
            if (newBounds[0][0] < left){
              left = newBounds[0][0];
            }
            if (newBounds[1][1] > bottom){
              bottom = newBounds[1][1];
            }
            if (newBounds[1][0] > right){
              right = newBounds[1][0];
            }
          }
      });
     
      mainMap.svg.attr("width",  right - left)
            .attr("height", bottom - top)
            .style("left", left + "px")
            .style("top", top + "px");
        mainMap.g1.attr("transform", "translate(" + -left + "," + -top + ")");
        mainMap.g2.attr("transform", "translate(" + -left + "," + -top + ")");
}

  function makeColorClosure(){
      var closureColorIndex = 0;
      var closure = function () {
          var color = mainMap.colors[closureColorIndex];
          closureColorIndex = (closureColorIndex + 1) % mainMap.colors.length;
          return color; 
      }   
  return closure;  
  }       
  function applyLatLngToLayer(d) {
      var y = d.geometry.coordinates[1];
      var x = d.geometry.coordinates[0];
      return mainMap.map.latLngToLayerPoint(new L.LatLng(y, x))
  }

  var getColor = makeColorClosure();   
  function geojsonToLinepaths(g, data) { 
      features = data.map(function(d) {return d.pathCoords}); //list of lists of the features
      var linepaths = g.selectAll("path")
          .data(features)
          .enter()
          .append("path")
          .attr("d", lineGenerator)
          .attr("stroke", getColor)
          .attr("stroke-width", 3)
          .attr("stroke-linecap", "round")
          .attr("stroke-opacity", .3)
          .attr("fill-opacity", "0");
      return linepaths;
  }

  function geojsonToHighlightedLinepaths(g, data) {
     features = data.map(function(d) {return d.pathCoords}); //list of lists of the features
      var linepaths = g.selectAll("path")
          .data(features)
          .enter()
          .append("path")
          .attr("d", lineGenerator)
          .attr("stroke", getColor)
          .attr("stroke-linecap", "round")
          .attr("stroke-width", 11)
          .attr("stroke-opacity", 1)
          .attr("fill-opacity", "0")
          .attr("class", getColor);
      return linepaths;
  }

  function setupLinePaths(linepaths) { 
      linepaths.each(function(d){  d.totalLength = this.getTotalLength();})
        .attr("stroke-dasharray", function(d){ return d.totalLength;})
        .attr("stroke-dashoffset", function(d){return d.totalLength;});
   }

   function setupHighlightedLinePaths(highlightedLinepaths){
      highlightedLinepaths.each(function(d) { d.totalLength = this.getTotalLength();})
        .attr("stroke-dasharray", function(d){ return [1, d.totalLength];})
        .attr("stroke-dashoffset", function(d){return d.totalLength;});
   }
          
  function drawMapAtTime(linepaths, geojsons, time){    
    // find fraction of journey completed, update linepath dashoffset   
         linepaths.each(function(d, i){ 
          d.geojson = geojsons[i];
          d.totalLength = this.getTotalLength();})     
         .attr("stroke-dashoffset", function(d) {return fractionOfJourneyCompleted(d.geojson,time) * d.totalLength + d.totalLength;})      
         $( "#seekbar" ).val((time/worldState.maxtimestamp) * 100);
         $(".seekbarvalue").html(formatCurrentDay(time)
          );


      // For showing the context messages 
        var eventCollection = [
          { starttime: 1620, endtime: 7000 , message: 'Four days until baby\'s birth', textcolor: maincolor },
          { starttime: 48001, endtime: 120001, message: 'Three days until baby\'s birth', textcolor: maincolor },
          { starttime: 133901, endtime: 180000, message: 'Two days until baby\'s birth', textcolor: maincolor },
          { starttime: 220000, endtime: 300000, message: 'One day until baby\'s birth', textcolor: maincolor },
          { starttime: 300020, endtime: 326000,  message: 'Mother goes to hospital', textcolor: color1 },
          { starttime: 326020, endtime: 331210,  message: 'Grandmother joins at hospital', textcolor: color3 },
          { starttime: 331220, endtime: 361210,  message: 'Father joins at hospital', textcolor: color2 },
          { starttime: 361220, endtime: 392140,  message: '**Baby\'s birth!**', textcolor: specialeventscolor },
          { starttime: 392151, endtime: 419294,  message: 'Father drops by home', textcolor: color2 },
          { starttime: 430864, endtime: 444500,  message: 'Grandmother drops by home', textcolor: color3 },
          { starttime: 464820, endtime: 599210,  message: 'Mother + Baby still at hospital', textcolor: color1 },
          { starttime: 599220, endtime: 626010,  message: 'Mother and Baby come home for first time', textcolor: color1 },
          { starttime: 653585, endtime: 771210,  message: 'First time Mother, Father, and Baby are all home', textcolor: specialeventscolor},
          { starttime: 771220, endtime: 914810,  message: 'Father goes back to work (four days after birth)', textcolor: color2 },
          { starttime: 923875, endtime: 943875,  message: 'Mother leaves house for first time since birth (6 days after birth)', textcolor: color1 },
          { starttime: 954820, endtime: 1231026.6,  message: 'End of baby\'s first week of life', textcolor: maincolor },
          { starttime: 1281026.6, endtime: 1449800,  message: 'Mother\'s second time leaving house since baby\'s birth', textcolor: color1 },
          { starttime: 1449887, endtime: 1594000,  message: 'Mother\'s longest trip since baby\'s birth (2 weeks post-birth)', textcolor: color1 },
          { starttime: 1594747, endtime: 2000000,  message: 'End of baby\'s second week of life', textcolor: maincolor },
          { starttime: 2013041, endtime: 2196000,  message: 'Grandmother leaves town, returns to home country', textcolor: color3 },
          { starttime: 2196045, endtime: 2232000,  message: 'End of baby\'s third week of life', textcolor: maincolor },
        ];

        matchingEvents = [];

        //add in day before baby's birth, and etc. needs to be something happening every 30 seconds or so. and add in the days as well prfacing
        
        eventCollection.getEventsForTime = function(timestep) {
          for (var x = 0; x < eventCollection.length; x++) {
            if (timestep >= eventCollection[x].starttime && timestep <= eventCollection[x].endtime){
              matchingEvents.push(eventCollection[x]);
            }
          } return matchingEvents;
        }     
       var returnedEvents = eventCollection.getEventsForTime(time)
          if (returnedEvents[0] && returnedEvents[0].textcolor && returnedEvents[0].message) {
              var currentColor = returnedEvents[0].textcolor;
              var currentMessage = returnedEvents[0].message; }   
       $("#message").css("color", currentColor);      
       return $("#message").html(currentMessage);     
    }
        
  function fractionOfJourneyCompleted(geojson, time) {
        var geojsonTimeValues = []
        $.each(geojson.features, function(key, value){       
            geojsonTimeValues.push(geojson.features[key].properties.t)
            answer = findClosestTimeValue(time, geojsonTimeValues);
            correspondingIndex = geojsonTimeValues.indexOf(answer);  
        });
        fractionValue = geojson.features[correspondingIndex].properties["total_distance"]/geojson.features[(geojsonTimeValues.length-1)].properties["total_distance"];
        return fractionValue;
  }

  function findClosestTimeValue(number, array) {
      var currentValue = array[0];
      var difference = Math.abs(number - currentValue);
      for (var value = 0; value < array.length; value++){
        var newDifference = Math.abs(number - array[value]);
        if (newDifference < difference){
          difference = newDifference;
          currentValue = array[value];
        }
      }
      return currentValue;
  }

  function getAllGeoJsons(urls, callback) {
      var results = []; 
      // introduce new scope to capture loop index 
      var loaded = function(i){
        return function(data){
        results[i] = data;
        } 
      } 
      //Kick off requests to all files and store them in results
      for (var i = 0; i < urls.length; i++){
          var url = urls[i];
          var dataIndex = i;
          results.push(null);
          d3.json(url, loaded(i));
      }
      timeoutFunc = function(){
      var loaded = true;
      // If no nulls, then we've finished loading.
      for(var i = 0; i < results.length; i++){
          if(results[i] == null){
            loaded = false
          }
      }
      if(loaded) {
          callback(results);
        } else {
            setTimeout(timeoutFunc, 100);
        }
      };
      setTimeout(timeoutFunc, 100) // check every 1/10 second if we have finished loading
  }

   function render(geojsons) {
      mainMap.g1.selectAll("path").remove();
      mainMap.g2.selectAll("path").remove();
      var linepaths = geojsonToLinepaths(mainMap.g1, geojsons);
      var highlightedLinepaths = geojsonToHighlightedLinepaths(mainMap.g2, geojsons);  
      setSVGHeightAndWidth(geojsons, highlightedLinepaths);
      setupLinePaths(linepaths);
      setupHighlightedLinePaths(highlightedLinepaths);

      self = this;
      setInterval(function(){
        if (worldState.timestep < 2468336){
        assignTimeValue();
        linepaths.each(function(linepath, index){
              if (index == 0) {
                drawMapAtTime(linepaths,geojsons,self.timestep);
              }
           });
        highlightedLinepaths.each(function(highlightedLinepath, index){
              if (index == 0) {
                drawMapAtTime(highlightedLinepaths,geojsons,self.timestep);
              }
           });
          if(self.playing){
              self.timestep += self.multiplier;
          }
        }
         else {
            $('#endingModal').foundation('reveal', 'open');
          }
      }, 100);
  }
  
  //Entry function that gets GeoJSON files, waits until all are loaded. 
  getAllGeoJsons(["Group3Data/mother.json", "Group3Data/father.json", "Group3Data/motherinlaw.json"], function(results) {
    results.forEach(function(result){
        result.pathCoords = result.features.slice();
        result.pathCoords.reverse();
    });

    var timestamps = results.map(function(d) {return d.features.slice(-1)[0].properties.t });
    worldState.maxtimestamp = Math.max.apply(null, timestamps);
    worldState.render(results);
    worldState.play();
    mainMap.map.on("viewreset", function() { worldState.render(results) });
  })
  
// Overlay Controls 
$(document).foundation();


//Buttons
$("#playbtn").click(function(){ 
  worldState.play(); 
  $("#playbtn").addClass('active'); 
  $("#pausebtn").removeClass('active');
  $("#resetbtn").removeClass('active');
});
$("#pausebtn").click(function(){ 
  worldState.pause(); 
  $("#pausebtn").addClass('active'); 
  $("#playbtn").removeClass('active');
  $("#resetbtn").removeClass('active');
});
$("#resetbtn").click(function(){ 
  worldState.reset(); 
});


// Timer
function formatTimestep() {
  return moment.unix(worldState.timestep + initialTimestamp).format("dddd, MMM Do HH:mm");
}
function assignTimeValue() {
  $("#timevalue").html(formatTimestep());
}

$(function() {
    $( "#slider" ).slider();
  });


$( "#seekbar" ).on( "change", function() {
  var sliderValue = $('#seekbar').val();
  worldState.timestep = sliderValue * worldState.maxtimestamp * 0.01;
} );

function formatCurrentDay(currentTimestamp) {
  var initialMoment = moment(initialTimestamp);
  var offset = initialMoment.hours() * 3600 + initialMoment.minutes() * 60 + initialMoment.seconds();
  var dayTimestamp = currentTimestamp + offset;
  return ("Day " + (moment.duration(dayTimestamp, "seconds").days() + 1) + " of 30");
}

// Modal Actions 
$(document).on('opened.fndtn.reveal', '[data-reveal]', function () {
  worldState.pause();
  var modal = $(this);
});

$(document).on('closed.fndtn.reveal', '[data-reveal]', function () {
  worldState.play();
  var modal = $(this);
});

$('a.close').on('click', function() {
  $('#endingModal').foundation('reveal', 'close');
});




var worldState = {
    maxtimestamp: 0,
    timestep: 1,
    multiplier: 2000,
    render: render, 
    playing: true,
    play: function(){
      this.playing = true;
    },
    pause: function(){
      this.playing = false;
    },
    reset: function(){     
      worldState.timestep = 0;
    },
    changeSpeed: function(){
      worldState.multiplier = realSliderValue[0] + worldState.multiplier;
    }
  };





 // find events to render at time
 //         event collection = list of objects, each one has start end message
 //         method in the event collection (geteventsfortime, function that you pass a timestep to, it returns all of the events) --> when you pass it a time, it finds all events that have a startime less than or equal and endtiem greater than or less
 //         then drawmapattime, 



</script>
 


</body>
</html>

